name: Build & Publish Resourcepack

on:
  push:
    branches: [ main ]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Make build dir
        run: |
          rm -rf build
          mkdir -p build

      - name: Zip resourcepack
        run: |
          # Zorg dat je pack in de map 'resourcepack' staat
          cd resourcepack
          zip -r ../build/resourcepack.zip .
          cd ..

      - name: Compute SHA1
        run: |
          sha1sum build/resourcepack.zip | awk '{print $1}' > build/sha1.txt
          echo "SHA1=$(cat build/sha1.txt)" >> $GITHUB_ENV

      - name: Create latest.json (met directe GitHub Pages URL)
        run: |
          OWNER=${{ github.repository_owner }}
          REPO=${{ github.event.repository.name }}
          URL="https://${OWNER}.github.io/${REPO}/resourcepack.zip"
          echo "{\"url\":\"${URL}\",\"sha1\":\"${SHA1}\"}" > build/latest.json

      - name: Prepare publish folder
        run: |
          mkdir -p build/public
          mv build/resourcepack.zip build/latest.json build/public/

      - name: Deploy to GitHub Pages (gh-pages branch)
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./build/public
          publish_branch: gh-pages
          # optioneel: commit author
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
